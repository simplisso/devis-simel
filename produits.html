<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMEL S.E.S | Catalogue & Quantit√©s</title>
    <link rel="stylesheet" href="style-pro.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .grille-produits {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .produit-card {
            background: white; border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; transition: 0.3s;
            display: flex; flex-direction: column; position: relative;
        }
        .produit-card:hover { border-color: var(--blue); transform: translateY(-5px); box-shadow: var(--shadow); }
        
        .badge-cat { background: #EBF8FF; color: var(--blue); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; align-self: flex-start; }
        
        .caract-text { font-size: 0.85rem; color: #718096; margin-bottom: 15px; border-left: 2px solid #CBD5E0; padding-left: 10px; }

        .add-product-box { background: #ffffff; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid var(--blue); }
        
        .flex-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        
        .panier-summary {
            position: sticky; bottom: 20px; background: var(--primary);
            color: white; padding: 15px 30px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; margin-top: 40px;
        }
        
        /* Style pour la demande de quantit√© rapide */
        .qte-input { width: 60px !important; padding: 5px !important; text-align: center; margin-right: 10px; }
    </style>
</head>
<body>

    <header class="header-simel">
        <div class="logo" id="header-ent-nom">SIMEL <span>S.E.S</span></div>
        <div id="info-client-header" style="font-weight: bold; color: var(--accent);"></div>
    </header>

    <main class="main-container" style="max-width: 1200px;">
        
        <div class="add-product-box animate-in">
            <h2 style="font-size: 1.1rem; margin-top: 0; color: var(--blue);"><i class="fas fa-plus-circle"></i> Ajouter un article au catalogue</h2>
            <div class="flex-form">
                <div>
                    <label>D√©signation</label>
                    <input type="text" id="new-nom" placeholder="Ex: Panneau Solaire 400W">
                </div>
                <div>
                    <label>Prix HT (FCFA)</label>
                    <input type="number" id="new-prix" placeholder="0">
                </div>
                <div>
                    <label>Cat√©gorie</label>
                    <input type="text" id="new-cat" list="liste-categories" placeholder="Saisir ou choisir">
                    <datalist id="liste-categories">
                        <option value="√âlectricit√©">
                        <option value="Solaire">
                        <option value="Froid">
                        <option value="Prestation de service">
                    </datalist>
                </div>
                <div style="grid-column: span 2;">
                    <label>Caract√©ristiques / Sp√©cifications</label>
                    <input type="text" id="new-caract" placeholder="Ex: Marque, Puissance, Garantie, Dimensions...">
                </div>
                <button onclick="enregistrerNouveauProduit()" class="btn-simel" style="height: 45px; align-self: flex-end;">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>

        <div class="card-pro">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h1 style="margin:0;"><i class="fas fa-list"></i> Articles Disponibles</h1>
                <input type="text" id="recherche" placeholder="üîç Rechercher un article..." onkeyup="afficherCatalogue()" style="width: 300px;">
            </div>

            <div id="liste-produits" class="grille-produits"></div>
        </div>

        <div class="panier-summary">
            <div>
                <i class="fas fa-shopping-cart"></i> <span id="nb-articles">0 article</span> | 
                <strong>Total HT: <span id="total-ht">0</span> FCFA</strong>
            </div>
            <button onclick="validerVersDevis()" class="btn-simel" style="width: auto; background: white; color: var(--primary); border: none;">
                G√©n√©rer le document <i class="fas fa-file-invoice"></i>
            </button>
        </div>
    </main>

    <script>
        let panier = [];

        // 1. Initialisation des donn√©es
        document.addEventListener('DOMContentLoaded', () => {
            const entNom = localStorage.getItem("ent_nom") || "SIMEL S.E.S";
            document.getElementById('header-ent-nom').innerHTML = `${entNom.split(' ')[0]} <span>${entNom.split(' ').slice(1).join(' ')}</span>`;
            document.getElementById('info-client-header').innerText = "Client : " + (localStorage.getItem("client") || "Inconnu");
            afficherCatalogue();
        });

        // 2. Gestion du catalogue (Base + Local)
        function getCatalogue() {
            const base = [
                { id: 'b1', nom: "Disjoncteur 16A Schneider", prix: 4500, cat: "√âlectricit√©", caract: "Courbe C, Unipolaire + Neutre" },
                { id: 'b2', nom: "C√¢ble 2.5mm¬≤ (100m)", prix: 32000, cat: "√âlectricit√©", caract: "Couleur Rouge/Bleu/Vert-Jaune" }
            ];
            const persos = JSON.parse(localStorage.getItem("catalogue_perso") || "[]");
            return [...base, ...persos];
        }

        function enregistrerNouveauProduit() {
            const nom = document.getElementById("new-nom").value;
            const prix = parseFloat(document.getElementById("new-prix").value);
            const cat = document.getElementById("new-cat").value;
            const caract = document.getElementById("new-caract").value;

            if (!nom || isNaN(prix)) return alert("Nom et Prix HT requis !");

            const nouveau = { id: Date.now(), nom, prix, cat, caract };
            const persos = JSON.parse(localStorage.getItem("catalogue_perso") || "[]");
            persos.push(nouveau);
            localStorage.setItem("catalogue_perso", JSON.stringify(persos));

            // Reset champs
            ["new-nom", "new-prix", "new-cat", "new-caract"].forEach(id => document.getElementById(id).value = "");
            afficherCatalogue();
        }

        // 3. Affichage et Filtre
        function afficherCatalogue() {
            const catalogue = getCatalogue();
            const search = document.getElementById("recherche").value.toLowerCase();
            const container = document.getElementById("liste-produits");
            container.innerHTML = "";

            catalogue.filter(p => p.nom.toLowerCase().includes(search)).forEach(p => {
                container.innerHTML += `
                    <div class="produit-card">
                        <span class="badge-cat">${p.cat || 'G√©n√©ral'}</span>
                        <h3 style="margin:0 0 10px 0;">${p.nom}</h3>
                        <p class="caract-text">${p.caract || 'Pas de d√©tails techniques'}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto;">
                            <span style="font-weight:bold; color:var(--blue); font-size:1.1rem;">${p.prix.toLocaleString()} F</span>
                            <div style="display:flex; align-items:center;">
                                <input type="number" id="qte-${p.id}" value="1" min="1" class="qte-input">
                                <button onclick="ajouterAuPanier('${p.id}')" class="btn-simel" style="width:40px; padding:0; height:40px;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 4. Gestion du panier (Devis en cours)
        function ajouterAuPanier(id) {
            const p = getCatalogue().find(prod => prod.id == id || prod.id === id);
            const qte = parseFloat(document.getElementById(`qte-${id}`).value) || 1;

            const articleDevis = {
                nom: p.nom,
                prix: p.prix,
                caract: p.caract,
                quantite: qte,
                totalLigne: p.prix * qte
            };

            panier.push(articleDevis);
            MAJ_UI_Panier();
        }

        function MAJ_UI_Panier() {
            document.getElementById("nb-articles").innerText = panier.length + " article(s)";
            const total = panier.reduce((sum, item) => sum + item.totalLigne, 0);
            document.getElementById("total-ht").innerText = total.toLocaleString();
        }

        function validerVersDevis() {
            if(panier.length === 0) return alert("Veuillez ajouter au moins un article.");
            localStorage.setItem("devis_final_produits", JSON.stringify(panier));
            window.location.href = "devis.html";
        }
    </script>
</body>
</html>