<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMEL S.E.S | Logiciel Devis</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.kkiapay.me/k.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root { 
        --primary: #2d3748; 
        --accent: #e53e3e; 
        --blue: #3182ce; 
        --green: #2f855a; 
    }

    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: #f4f7f6; 
        margin: 0; 
        padding: 0; 
    }

    /* Barre d'outils */
    .toolbar {
        background: #1a202c; 
        padding: 12px 25px; 
        color: white;
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        position: sticky; 
        top: 0; 
        z-index: 1000; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .btn-group { display: flex; gap: 12px; }
    .btn-auth { background: transparent; border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 13px; }
    .btn-pdf { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-excel { background: var(--green); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

    /* Conteneur principal */
    .page-container { 
        padding: 30px; 
        display: flex; 
        justify-content: center; 
        background: #f4f7f6;
    }

    /* La Page A4 - Correction décalage PC */
    .page {
        background: white; 
        width: 210mm; 
        min-height: 297mm;
        padding: 20mm; 
        box-shadow: 0 0 20px rgba(0,0,0,0.1); 
        box-sizing: border-box;
        position: relative;
        margin: 0 auto; /* Force le centrage sur PC */
        overflow: hidden;
    }

    /* En-tête */
    .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: flex-start;
        border-bottom: 3px solid var(--primary); 
        padding-bottom: 20px; 
        margin-bottom: 30px;
        width: 100%;
    }

    #logo-view { max-width: 130px; max-height: 100px; object-fit: contain; }

    .company-info { 
        flex: 1; 
        padding-left: 20px; 
        max-width: 60%; 
    }
    
    .company-info h1 { margin: 0; color: var(--primary); font-size: 26px; line-height: 1.2; }
    .company-info p { margin: 5px 0 0 0; font-size: 12px; color: #555; white-space: pre-line; }

    .devis-title { text-align: right; min-width: 150px; }
    .devis-title h2 { margin: 0; color: var(--accent); font-size: 32px; font-weight: 800; }

    /* Grille Client / Expert */
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    .info-card {
        padding: 18px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 5px solid var(--blue);
    }
    .info-card.expert { border-left-color: var(--primary); }
    .info-card small { text-transform: uppercase; color: #666; font-size: 11px; display: block; margin-bottom: 5px; }
    .info-card strong { font-size: 18px; color: #2d3748; }

    /* TABLEAU - Verrouillage des largeurs */
    table { 
        width: 100% !important; 
        border-collapse: collapse; 
        margin-top: 20px; 
        table-layout: fixed; 
    }

    th { 
        background: var(--primary); 
        color: white; 
        padding: 12px; 
        text-align: left; 
        font-size: 13px; 
        text-transform: uppercase;
    }

    /* Fixation des colonnes */
    th:nth-child(1) { width: 60%; } 
    th:nth-child(2) { width: 10%; text-align: center; } 
    th:nth-child(3) { width: 30%; text-align: right; } 

    td { 
        padding: 12px; 
        border-bottom: 1px solid #eee; 
        font-size: 14px; 
        word-wrap: break-word; 
        vertical-align: top; 
        line-height: 1.4;
    }

    /* Empêche les coupures de lignes entre les pages */
    tr { page-break-inside: avoid !important; break-inside: avoid !important; }

    /* Section Totaux */
    .totals-container { 
        display: flex; 
        flex-direction: column; 
        align-items: flex-end; 
        margin-top: 40px; 
        page-break-inside: avoid; 
    }
    
    .total-box { min-width: 350px; }
    .total-row { 
        display: flex; 
        justify-content: space-between; 
        padding: 10px 0; 
        border-bottom: 1px solid #f0f0f0; 
        font-size: 15px; 
    }

    .net-a-payer {
        background: var(--accent); 
        color: white; 
        padding: 18px; 
        border-radius: 8px;
        margin-top: 15px; 
        display: flex; 
        justify-content: space-between; 
        font-weight: bold; 
        font-size: 1.4rem;
    }

    /* Pied de page */
    .footer-devis { 
        margin-top: 60px; 
        font-size: 11px; 
        color: #999; 
        text-align: center; 
        border-top: 1px dashed #ccc; 
        padding-top: 20px; 
    }

    @media print {
        body { background: white; }
        .toolbar { display: none !important; }
        .page-container { padding: 0; }
        .page { box-shadow: none; margin: 0; width: 210mm; padding: 15mm; }
    }
</style>
</head>
<body>

    <div class="toolbar no-print">
        <div style="font-weight: bold; font-size: 1.2rem;">⚡ SYSTEME SIMEL S.E.S</div>
        <div class="btn-group">
            <a href="login.html" id="auth-link" class="btn-auth"><i class="fas fa-user-shield"></i> Accès Admin</a>
            <button onclick="genererPDF()" class="btn-pdf"><i class="fas fa-file-pdf"></i> TÉLÉCHARGER PDF</button>
            <button onclick="gererTelechargement('excel')" class="btn-excel"><i class="fas fa-file-excel"></i> EXCEL</button>
        </div>
    </div>

    <div class="page-container">
        <div class="page" id="capture-area">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                    <div id="logo-container" style="display: none;"><img id="logo-view" src=""></div>
                    <div class="company-info">
                        <h1 id="ent-nom-view">SIMEL S.E.S</h1>
                        <p id="ent-details-view"></p>
                    </div>
                </div>
                <div class="devis-title">
                    <h2>DEVIS</h2>
                    <p>Date: <span id="date-view"></span></p>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <small>Client :</small>
                    <strong id="client-view"></strong>
                </div>
                <div class="info-card expert">
                    <small>Expert :</small>
                    <strong id="expert-view">OLOUBI Simplice</strong>
                </div>
            </div>

            <table id="table-devis">
                <thead>
                    <tr>
                        <th>DESCRIPTION DES PRESTATIONS / ARTICLES</th>
                        <th>QTÉ</th>
                        <th>TOTAL (FCFA)</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>

            <div class="totals-container">
                <div class="total-box">
                    <div class="total-row"><span>Total Matériel</span><strong id="res-matos">0 F</strong></div>
                    <div class="total-row"><span>Main d'œuvre</span><strong id="res-main">0 F</strong></div>
                    <div class="total-row"><span>TVA (18%)</span><strong id="res-tva">0 F</strong></div>
                    <div class="net-a-payer">
                        <span>NET À PAYER :</span>
                        <span id="res-ttc">0 FCFA</span>
                    </div>
                </div>
            </div>
            
            <div class="footer-devis">
                Ce devis est valable 30 jours. SIMEL S.E.S vous remercie de votre confiance.
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mvtqrvbdhvdaxlfhgyqq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12dHFydmJkaHZkYXhsZmhneXFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NzMwNDAsImV4cCI6MjA4MjM0OTA0MH0.LJRT3MJpGmlZHyZ0Zdn3HliE3RsWu6XlgrYsBOyLbM8'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkAdminStatus() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                const { data: profile } = await _supabase.from('profiles').select('is_admin').eq('id', session.user.id).maybeSingle();
                if (profile && profile.is_admin) {
                    const btn = document.getElementById('auth-link');
                    btn.innerHTML = "<i class='fas fa-check-circle'></i> ADMIN CONNECTÉ";
                    btn.style.color = "#48bb78"; btn.style.borderColor = "#48bb78";
                    return true;
                }
            }
            return false;
        }

        async function gererTelechargement(format) {
    const isAdmin = await checkAdminStatus();

    if (isAdmin) {
        format === 'pdf' ? genererPDF() : genererExcel();
    } else {
        // Configuration de FedaPay
        FedaPay.init({
            public_key: 'pk_live_JPQ8hLBe9RENF2ojZZ4bMO3J',
            transaction: {
                amount: 500,
                description: 'Paiement Devis SIMEL'
            },
            onComplete: function(response) {
                if (response.status === 'approved') {
                    // Si le paiement est réussi, on génère le document
                    // Note : Ici, on choisit le PDF par défaut ou selon le format
                    format === 'pdf' ? genererPDF() : genererExcel();
                } else {
                    alert("Le paiement n'a pas pu être complété.");
                }
            }
        }).open();
    }
}

// Vous pouvez supprimer l'écouteur 'kkiapay_resolved' car 
// la logique est maintenant gérée dans le 'onComplete' de FedaPay.

       function genererPDF() {
    // On cible l'élément à capturer
    const element = document.getElementById('capture-area');
    
    // Récupération du nom du client pour le nom du fichier
    const clientName = document.getElementById('client-view').innerText || "Client";

    // --- ÉTAPE 1 : Verrouillage pour PC ---
    // On sauvegarde le style original pour le remettre plus tard
    const originalWidth = element.style.width;
    const originalMargin = element.style.margin;

    // On force la largeur A4 en pixels pour éviter que le navigateur PC ne décale le contenu
    element.style.width = "794px"; 
    element.style.margin = "0"; 
    element.style.boxShadow = "none";

    // --- ÉTAPE 2 : Configuration de html2pdf ---
    const opt = {
        margin: 0,
        filename: 'Devis_SIMEL_' + clientName + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2, 
            useCORS: true, 
            letterRendering: true,
            scrollY: 0,
            width: 794,      // Force la capture à 794px de large
            windowWidth: 794 // Simule une fenêtre de 794px pour le calcul du CSS
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // --- ÉTAPE 3 : Lancement de la génération ---
    html2pdf().set(opt).from(element).save().then(() => {
        // --- ÉTAPE 4 : Restauration de l'affichage écran ---
        element.style.width = originalWidth;
        element.style.margin = originalMargin;
        element.style.boxShadow = "0 0 20px rgba(0,0,0,0.1)";
    }).catch(err => {
        console.error("Erreur lors de la génération PDF :", err);
        // Remise en état même en cas d'erreur
        element.style.width = originalWidth;
        element.style.boxShadow = "0 0 20px rgba(0,0,0,0.1)";
    });
}

        function genererExcel() {
            const table = document.getElementById('table-devis');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'Devis_SIMEL.xlsx');
        }

        function chargerDonnees() {
            const savedLogo = localStorage.getItem("ent_logo");
            if (savedLogo) {
                document.getElementById('logo-view').src = savedLogo;
                document.getElementById('logo-container').style.display = "block";
            }
            document.getElementById('ent-nom-view').innerText = localStorage.getItem("ent_nom") || "SIMEL S.E.S";
            document.getElementById('ent-details-view').innerText = localStorage.getItem("ent_details") || "Tél: +229 XX XX XX XX";
            document.getElementById('client-view').innerText = localStorage.getItem("client") || "OLOUBI Simplice";
            document.getElementById('date-view').innerText = localStorage.getItem("date") || new Date().toLocaleDateString();
            document.getElementById('expert-view').innerText = localStorage.getItem("electricien") || "OLOUBI Simplice";
            
            const produits = JSON.parse(localStorage.getItem("devis_final_produits") || "[]");
            let totalMatos = 0;
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            produits.forEach(p => {
                const total = p.prix * p.quantite;
                totalMatos += total;
                tbody.innerHTML += `<tr>
                    <td><strong>${p.nom}</strong><br><small style="color:#718096">${p.caract || ''}</small></td>
                    <td style="text-align:center">${p.quantite}</td>
                    <td style="text-align:right">${total.toLocaleString()} F</td>
                </tr>`;
            });
            
            const main = parseFloat(localStorage.getItem("mainManuelle")) || 0;
            const ht = totalMatos + main;
            const tva = Math.round(ht * 0.18);
            const ttc = ht + tva;

            document.getElementById('res-matos').innerText = totalMatos.toLocaleString() + " F";
            document.getElementById('res-main').innerText = main.toLocaleString() + " F";
            document.getElementById('res-tva').innerText = tva.toLocaleString() + " F";
            document.getElementById('res-ttc').innerText = ttc.toLocaleString() + " FCFA";
        }

        window.onload = async () => { 
            await checkAdminStatus(); 
            chargerDonnees(); 
        };
    </script>
    <script src="https://cdn.fedapay.com/checkout.js?v=1.1.7"></script>

</body>
</html>










